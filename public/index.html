<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("msg");
  const sendBtn = document.getElementById("send");

  let sessionId = localStorage.getItem("botSessionId") || "";

  function addMessage(text, who = "bot", meta = "") {
    const wrap = document.createElement("div");

    const bubble = document.createElement("div");
    bubble.className = "msg " + (who === "me" ? "me" : "bot");
    bubble.textContent = text;

    wrap.appendChild(bubble);

    if (meta) {
      const m = document.createElement("div");
      m.className = "meta";
      m.textContent = meta;
      wrap.appendChild(m);
    }

    chat.appendChild(wrap);
    chat.scrollTop = chat.scrollHeight;
  }

  async function send() {
    const text = (input.value || "").trim();
    if (!text) return;

    input.value = "";
    addMessage(text, "me");

    try {
      const r = await fetch("/api/analyze", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, sessionId })
      });

      let data;
      try {
        data = await r.json();
      } catch {
        addMessage("Invalid server response (not JSON). Check Render logs.", "bot");
        return;
      }

      if (!r.ok) {
        addMessage("Server error: " + (data?.error || r.statusText), "bot");
        return;
      }

      // Save session ID if provided
      if (data.sessionId) {
        sessionId = data.sessionId;
        localStorage.setItem("botSessionId", sessionId);
      }

      // Show reply
      addMessage(data.reply || "No reply from server.", "bot");

      // Optional meta display
      if (data.meta) {
        const metaText = Object.entries(data.meta)
          .map(([k, v]) => `${k}: ${v}`)
          .join(" | ");
        addMessage(metaText, "bot", "");
      }

    } catch (e) {
      console.error(e);
      addMessage("Could not reach the server. Is the Render service running?", "bot");
    }
  }

  sendBtn.addEventListener("click", send);

  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") send();
  });

  addMessage(
    "Hi! I’m your Tech Support Copilot. Tell me what’s wrong and I’ll guide you step-by-step.",
    "bot"
  );
</script>
