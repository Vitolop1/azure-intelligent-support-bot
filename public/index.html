<script>
  window.addEventListener("DOMContentLoaded", () => {
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send");

    if (!chat || !input || !sendBtn) {
      console.error("Missing #chat, #msg, or #send element in HTML.");
      return;
    }

    let sessionId = localStorage.getItem("botSessionId") || "";

    function addMessage(text, who = "bot") {
      const wrap = document.createElement("div");
      const bubble = document.createElement("div");
      bubble.className = "msg " + (who === "me" ? "me" : "bot");
      bubble.textContent = text;

      wrap.appendChild(bubble);
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    async function send() {
      const text = (input.value || "").trim();
      if (!text) return;

      input.value = "";
      addMessage(text, "me");

      try {
        const r = await fetch("/api/analyze", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, sessionId }),
        });

        let data = null;
        const contentType = r.headers.get("content-type") || "";
        if (contentType.includes("application/json")) {
          data = await r.json();
        } else {
          const raw = await r.text();
          addMessage(`Server returned non-JSON:\n${raw.slice(0, 300)}`, "bot");
          return;
        }

        if (!r.ok) {
          addMessage(`Server error (${r.status}): ${data?.error || r.statusText}`, "bot");
          return;
        }

        if (data.sessionId) {
          sessionId = data.sessionId;
          localStorage.setItem("botSessionId", sessionId);
        }

        addMessage(data.reply || "No reply from server.", "bot");
      } catch (e) {
        console.error(e);
        addMessage("Could not reach the server. If using Render Free, it may be waking up â€” try again in a few seconds.", "bot");
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    addMessage("Hi! Tell me your issue and Iâ€™ll guide you step-by-step. Type `start` to begin.", "bot");
  });
</script>
